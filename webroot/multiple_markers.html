<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <script type="text/javascript" src="//code.jquery.com/jquery-git.js"></script>

  <style type="text/css">
/* Always set the map height explicitly to define the size of the div
 * element that contains the map. */
#map {
  height: 100%;
}
/* Optional: Makes the sample page fill the window. */
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}
#floating-panel {
  position: absolute;
  top: 10px;
  left: 25%;
  z-index: 5;
  background-color: #fff;
  padding: 5px;
  border: 1px solid #999;
  text-align: center;
  font-family: 'Roboto','sans-serif';
  line-height: 30px;
  padding-left: 10px;
}
  </style>

  <title></title>

<script type='text/javascript'>//<![CDATA[
function initMap() {
  var directionsService = new google.maps.DirectionsService;
  var directionsDisplay = new google.maps.DirectionsRenderer;
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 13,
    center: {lat:35.5086529, lng:135.0703902}
  });
  directionsDisplay.setMap(map);

  var onChangeHandler = function() {
    calculateAndDisplayRoute(directionsService, directionsDisplay);
  };
  document.getElementById('start').addEventListener('change', onChangeHandler);
  document.getElementById('end').addEventListener('change', onChangeHandler);

  animator = new Animator();
  animator.start();
  
  // Listen on Firebase Database.
  var pingRef =  firebase.database().ref('/ping');
  pingRef.on('value', function(snapshot) {
    var val = snapshot.val();
    console.log("pinged:");
    console.log(val);
    if (val && val.index >= 0) {
      var start = document.getElementById('start');
      start.selectedIndex = val.index;
      calculateAndDisplayRoute(directionsService, directionsDisplay);
    }
  });
}

function StepMarker(map, route, num_steps) {
  this.map = map;
  this.steps = [];
  this.curr_index = 0;
  this.marker = new google.maps.Marker();

  var points = [];
  for (var leg_i = 0; leg_i < route.legs.length; ++leg_i) {
    var leg = route.legs[leg_i];
    for (var step_i = 0; step_i < leg.steps.length; ++step_i) {
      var step = leg.steps[step_i];
      for (var path_i = 0; path_i < step.path.length; ++path_i) {
        var path = step.path[path_i];
        var point = {"latLng": path};
        if (points.length == 0) {
          point.len = 0;
          point.total = 0;
        } else {
          point.len = google.maps.geometry.spherical.computeDistanceBetween(
            points[points.length - 1].latLng, point.latLng);
          point.total = points[points.length - 1].total + point.len;
        }
        points.push(point);
      }
    }
  }
  if (points.length <= 1) {
    return;
  }

  var step_len = points[points.length - 1].total / num_steps;
  var curr = 0;
  for (var distance = step_len; distance < points[points.length - 1].total; distance += step_len) {
    while (points[curr].total < distance && curr < points.length - 1) {
      ++ curr;
    }
    var ratio = (distance - points[curr - 1].total) / points[curr].len;
    var lat = points[curr - 1].latLng.lat() * (1 - ratio) + points[curr].latLng.lat() * ratio;
    var lng = points[curr - 1].latLng.lng() * (1 - ratio) + points[curr].latLng.lng() * ratio;
    this.steps.push({"lat":lat, "lng":lng});
  }
};

StepMarker.prototype.reset = function() {
  this.curr_index = 0;
};

StepMarker.prototype.next = function() {
  ++this.curr_index;
  this.curr_index %= this.steps.length;
  this.redraw();
};

StepMarker.prototype.redraw = function() {
  if (! this.marker.getMap()) {
    this.marker.setMap(this.map);
  }
  this.marker.setPosition(this.steps[this.curr_index]);
};

StepMarker.prototype.hide = function() {
  this.marker.setMap(null);
};

function Animator(interval) {
  this.markers = [];
  this.interval = interval || 10;
  this.interval_id = null;
};

Animator.prototype.start = function() {
  this.interval_id = setInterval(function(animator) {
    var instance = animator;
    return function(){
      instance.next();
    }
  }(this), this.interval);
  console.log(this.markers);
};

Animator.prototype.stop = function() {
  clearInterval(this.interval_id);
  this.interval_id = null;
};

Animator.prototype.next = function() {
  this.markers.forEach(function(marker) {
    marker.next();
  });
};

Animator.prototype.hide = function() {
  this.stop();
  this.markers.forEach(function(marker) {
    marker.hide();
  });
};

Animator.prototype.clear = function() {
  this.hide();
  this.markers = [];
};

Animator.prototype.addMarker = function(marker) {
  this.markers.push(marker);
  this.markers.forEach(function(marker) {
    marker.reset();
  });
};

var map;
var animator;

function calculateAndDisplayRoute(directionsService, directionsDisplay) {
  directionsService.route({
    origin: document.getElementById('start').value,
    destination: document.getElementById('end').value,
    travelMode: 'DRIVING'
  }, function(response, status) {
    if (status === 'OK') {
      // directionsDisplay.setDirections(response);
      // ///////////////////////////////////////
      // Field Hack YOSANO.
      var route = response.routes[0];
      var marker = new StepMarker(map, route, 300);
      var path = new google.maps.Polyline({
        path: route.overview_path,
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 1.0,
        strokeWeight: 2
      });
      path.setMap(map);
      animator.addMarker(marker);
      // ///////////////////////////////////////
    } else {
      window.alert('Directions request failed due to ' + status);
    }
  });
}
//]]> 

</script>
  
</head>

<body>
<div id="floating-panel">
<b>Start: </b>
<select id="start">
  <option value="京都府与謝郡与謝野町与謝２−２">与謝娘酒造</option>
  <option value="35.475570, 135.090478">与謝娘酒造の水田</option>
  <option value="京都府与謝郡与謝野町字滝98">野菜直売所</option>
  <option value="京都府与謝郡与謝野町字与謝2098">乾燥所</option>
  <option value="京都府与謝郡与謝野町字与謝小字赤石２９２－２">水源</option>
  <option value="京都府与謝郡与謝野町字加悦奥1045">肥料工場</option>
  <option value="京都府与謝郡与謝野町字金屋１７３０">農作物加工工場</option>
</select>
<b>End: </b>
<select id="end">
  <option value="京都府与謝郡与謝野町与謝２−２">与謝娘酒造</option>
  <option value="35.475570, 135.090478" selected>与謝娘酒造の水田</option>
  <option value="京都府与謝郡与謝野町字滝98">野菜直売所</option>
  <option value="京都府与謝郡与謝野町字与謝2098">乾燥所</option>
  <option value="京都府与謝郡与謝野町字与謝小字赤石２９２－２">水源</option>
  <option value="京都府与謝郡与謝野町字加悦奥1045">肥料工場</option>
  <option value="京都府与謝郡与謝野町字金屋１７３０">農作物加工工場</option>
</select>
</div>
<div id="map"></div>
<script src="https://www.gstatic.com/firebasejs/4.1.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyB375rUL5xK8GX8BtfRGoy-yBqarX93n18",
    authDomain: "field-hack-yosano-oryza-1ec51.firebaseapp.com",
    databaseURL: "https://field-hack-yosano-oryza-1ec51.firebaseio.com",
    projectId: "field-hack-yosano-oryza-1ec51",
    storageBucket: "field-hack-yosano-oryza-1ec51.appspot.com",
    messagingSenderId: "561290770409"
  };
  firebase.initializeApp(config);
</script>
<!-- Replace the value of the key parameter with your own API key. -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDrUmPwxmxyWknL8LU51wEZvVUKh9x2SbE&callback=initMap">
</script>
  
  <script>
  // tell the embed parent frame the height of the content
  if (window.parent && window.parent.parent){
    window.parent.parent.postMessage(["resultsFrame", {
      height: document.body.getBoundingClientRect().height,
      slug: "0pcr6fhp"
    }], "*")
  }
</script>

</body>

</html>
